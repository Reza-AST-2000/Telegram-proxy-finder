<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پروکسی یاب تلگرام</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@7.5.0/css/flag-icons.min.css">

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="پروکسی یاب">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <style>
        /* Dark theme variables (default) */
        :root {
            --bg-color: #010409;
            --card-bg-color: #0d1117;
            --border-color: rgba(255, 255, 255, 0.1);
            --text-color: #e6edf3;
            --text-secondary-color: #7d8590;
            --accent-color: #2f81f7;
            --success-color: #238636;
            --warning-color: #f59e0b;
            --danger-color: #da3633;
            --glow-color: rgba(47, 129, 247, 0.7);
        }

        /* Light theme variables */
        :root.light-theme {
            /* Modified for a soft sea blue theme */
            --bg-color: #eaf7ff;
            --card-bg-color: #ffffff;
            --border-color: #a0c0e0;
            --text-color: #2a3848;
            --text-secondary-color: #5c6778;
            --accent-color: #007bff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --glow-color: rgba(0, 123, 255, 0.5);
        }
        
        /* فونت و تنظیمات کلی */
        * {
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* چیدمان کارت‌های پروکسی */
        .proxy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(370px, 1fr));
            gap: 24px;
        }

        /* استایل کارت‌های پروکسی */
        .proxy-card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }

        .proxy-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: radial-gradient(
                600px circle at var(--mouse-x) var(--mouse-y),
                var(--glow-color),
                transparent 40%
            );
            opacity: 0;
            transition: opacity 0.4s ease-out;
            z-index: 0;
        }

        .proxy-card:hover::before {
            opacity: 0.1;
        }

        .proxy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: var(--accent-color);
        }

        .card-content {
            position: relative;
            z-index: 1;
        }

        /* استایل دکمه‌ها */
        .btn {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            color: white;
        }

        .btn-primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: #fff;
        }

        .btn-primary:hover {
            background: #1f6feb;
            box-shadow: 0 0 15px rgba(47, 129, 247, 0.5);
        }

        .btn-primary.light-theme:hover {
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }

        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
            color: #fff;
        }

        .btn-success:hover {
            background: #1e7e34;
            box-shadow: 0 0 15px rgba(35, 134, 54, 0.5);
        }

        .btn-danger {
            background: var(--danger-color);
            border-color: var(--danger-color);
            color: #fff;
        }

        .btn-danger:hover {
            background: #c62d2d;
            box-shadow: 0 0 15px rgba(218, 54, 51, 0.5);
        }
        
        .loading-animation {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-copy {
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        .btn-copy:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .badge-success {
            background-color: var(--success-color);
            color: #fff;
        }

        .badge-danger {
            background-color: var(--danger-color);
            color: #fff;
        }

        .badge-ping {
            animation: pulse-ping 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-ping {
            0%, 100% {
                box-shadow: 0 0 0 rgba(35, 134, 54, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(35, 134, 54, 0);
            }
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: var(--card-bg-color);
            color: var(--text-color);
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 100;
            bottom: 125%; /* Position the tooltip above the text */
            right: 50%;
            transform: translateX(50%);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* New style for the flag icons to ensure proper spacing and vertical alignment */
        .fi {
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px; /* For right-to-left layout */
        }
    </style>
    
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
    <header class="text-center mb-10">
        <h1 class="text-4xl font-extrabold text-white mb-2">پروکسی یاب تلگرام</h1>
        <p class="text-gray-400 text-lg">لیست بهترین و سریع‌ترین پروکسی‌های MTProto</p>
    </header>

    <main class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex flex-wrap gap-4">
                <button id="refreshBtn" class="btn btn-primary px-6 py-2 rounded-lg transition-all duration-300 transform active:scale-95">
                    <i class="fas fa-sync-alt mr-2"></i>
                    بارگذاری مجدد
                </button>
                <button id="testAllBtn" class="btn px-6 py-2 rounded-lg transition-all duration-300 transform active:scale-95">
                    <i class="fas fa-check-circle mr-2"></i>
                    تست همه
                </button>
                <div class="flex items-center gap-2">
                    <label for="sortSelect" class="text-gray-300">مرتب‌سازی:</label>
                    <select id="sortSelect" class="bg-gray-800 text-gray-200 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="fastest">سریع‌ترین</option>
                        <option value="newest">جدیدترین</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="perPageSelect" class="text-gray-300">تعداد در صفحه:</label>
                    <select id="perPageSelect" class="bg-gray-800 text-gray-200 border border-gray-700 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            <div class="w-full md:w-auto">
                <input type="text" id="searchInput" placeholder="جستجو بر اساس کشور..." class="w-full bg-gray-800 text-gray-200 border border-gray-700 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
            </div>
        </div>

        <div id="proxyGrid" class="proxy-grid">
            <p class="text-gray-500 text-center col-span-full" id="statusMessage">در حال بارگذاری پروکسی‌ها...</p>
        </div>
        
        <div class="flex justify-center mt-8" id="loadMoreContainer" style="display: none;">
            <button id="loadMoreBtn" class="btn btn-primary px-6 py-2 rounded-lg">
                بارگذاری بیشتر
            </button>
        </div>

    </main>
    
    <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-50 p-4" style="display: none;">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-lg w-full text-center border-2 border-blue-500 transform scale-95 transition-all duration-300">
            <h2 class="text-3xl font-extrabold text-blue-400 mb-4">به پروکسی یاب تلگرام خوش آمدید!</h2>
            <p class="text-gray-300 mb-6">
                این سایت به شما کمک می‌کند تا به راحتی به بهترین و سریع‌ترین پروکسی‌های تلگرام دسترسی پیدا کنید.
            </p>
            <p class="text-gray-400 text-sm mb-6">
                لطفا توجه داشته باشید که این پروکسی‌ها توسط منابع خارجی ارائه می‌شوند و ما مسئولیتی در قبال عملکرد یا امنیت آن‌ها نداریم.
            </p>
            <button id="closeModalBtn" class="btn btn-primary px-8 py-3 rounded-xl text-lg">
                متوجه شدم
            </button>
        </div>
    </div>
    
    <div id="toastContainer" class="fixed top-4 left-1/2 -translate-x-1/2 flex flex-col items-center space-y-2 z-50"></div>

    <script>
        const elements = {
            proxyGrid: document.getElementById('proxyGrid'),
            refreshBtn: document.getElementById('refreshBtn'),
            testAllBtn: document.getElementById('testAllBtn'),
            statusMessage: document.getElementById('statusMessage'),
            searchInput: document.getElementById('searchInput'),
            sortSelect: document.getElementById('sortSelect'),
            perPageSelect: document.getElementById('perPageSelect'),
            loadMoreBtn: document.getElementById('loadMoreBtn'),
            loadMoreContainer: document.getElementById('loadMoreContainer'),
            welcomeModal: document.getElementById('welcomeModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            toastContainer: document.getElementById('toastContainer')
        };
        
        let allProxies = [];
        let displayedProxiesCount = 0;
        const proxiesPerPage = 20;
        let currentSort = 'fastest';
        let perPage = 20;
        let currentSearch = '';

        const proxyApiUrl = 'https://api.github.com/repos/yebekhe/Telegram-MTProto/contents/proxies/mtproto.json';
        const testTimeout = 4000;
        
        // Updated country translations with ISO 3166-1 alpha-2 codes
        const countryTranslations = {
            'Russia': { code: 'ru', name: 'روسیه' },
            'United States': { code: 'us', name: 'ایالات متحده' },
            'Germany': { code: 'de', name: 'آلمان' },
            'China': { code: 'cn', name: 'چین' },
            'Netherlands': { code: 'nl', name: 'هلند' },
            'United Kingdom': { code: 'gb', name: 'بریتانیا' },
            'Canada': { code: 'ca', name: 'کانادا' },
            'Singapore': { code: 'sg', name: 'سنگاپور' },
            'France': { code: 'fr', name: 'فرانسه' },
            'India': { code: 'in', name: 'هند' },
            'South Korea': { code: 'kr', name: 'کره جنوبی' },
            'Japan': { code: 'jp', name: 'ژاپن' },
            'Poland': { code: 'pl', name: 'لهستان' },
            'Ukraine': { code: 'ua', name: 'اوکراین' },
            'Sweden': { code: 'se', name: 'سوئد' },
            'Iran': { code: 'ir', name: 'ایران' },
            'Kazakhstan': { code: 'kz', name: 'قزاقستان' },
            'Czech Republic': { code: 'cz', name: 'جمهوری چک' },
            'Brazil': { code: 'br', name: 'برزیل' },
            'Spain': { code: 'es', name: 'اسپانیا' }
        };
        
        function getCountryName(country) {
            const countryInfo = countryTranslations[country] || { code: 'xx', name: country };
            const flagClass = countryInfo.code !== 'xx' ? `fi fi-${countryInfo.code}` : '';
            return `<span class="${flagClass}"></span> ${countryInfo.name}`;
        }

        async function fetchProxies() {
            try {
                elements.statusMessage.classList.remove('hidden');
                elements.statusMessage.textContent = 'در حال دریافت اطلاعات پروکسی‌ها...';
                elements.proxyGrid.innerHTML = '';
                elements.loadMoreContainer.style.display = 'none';

                const response = await fetch(proxyApiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const content = atob(data.content);
                return JSON.parse(content);
            } catch (error) {
                console.error('Failed to fetch proxies:', error);
                elements.statusMessage.textContent = 'خطا در بارگذاری پروکسی‌ها. لطفا دوباره تلاش کنید.';
                return [];
            }
        }

        async function testProxy(proxy) {
            const testUrl = `https://api.telegram.org/api`;
            const testStart = performance.now();
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), testTimeout);

                const response = await fetch(testUrl, {
                    signal: controller.signal,
                    method: 'GET'
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    const testEnd = performance.now();
                    const ping = Math.round(testEnd - testStart);
                    return ping;
                } else {
                    return -1; // Indicate a failed test
                }
            } catch (error) {
                return -1; // Indicate a failed test
            }
        }

        function getPingBadgeHTML(ping) {
            const status = ping > 0 ? 'آنلاین' : 'آفلاین';
            const colorClass = ping > 0 ? 'badge-success badge-ping' : 'badge-danger';
            const pingText = ping > 0 ? `${ping} میلی‌ثانیه` : 'تست نشده';
            return `<span class="badge ${colorClass}">${status} - ${pingText}</span>`;
        }

        function getProxyCardHTML(proxy, index) {
            const countryName = getCountryName(proxy.country);
            const copyLink = `tg://proxy?server=${proxy.server}&port=${proxy.port}&secret=${proxy.secret}`;

            return `
                <div class="proxy-card flex flex-col" data-country="${proxy.country}">
                    <div class="card-content flex flex-col flex-grow">
                        <div class="flex-grow">
                            <h3 class="text-xl font-semibold mb-2">${countryName}</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-400 mb-4">
                                <div class="col-span-2 md:col-span-1">
                                    <span class="font-bold text-gray-300">سرور:</span> ${proxy.server}
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <span class="font-bold text-gray-300">پورت:</span> ${proxy.port}
                                </div>
                                <div class="col-span-2">
                                    <span class="font-bold text-gray-300">Secret:</span>
                                    <div class="tooltip inline-block relative cursor-pointer">
                                        ${proxy.secret.substring(0, 10)}...
                                        <span class="tooltip-text absolute z-10 p-2 text-xs bg-gray-700 text-white rounded shadow-lg bottom-full -mb-2">
                                            ${proxy.secret}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <span class="font-bold text-gray-300">پینگ:</span>
                                    <span id="ping-${index}" class="text-gray-400">در حال تست...</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-auto">
                            <a href="${copyLink}" class="btn btn-primary px-4 py-2 flex-grow text-center">
                                <i class="fas fa-paper-plane"></i> اتصال
                            </a>
                            <button class="btn px-4 py-2 flex-grow btn-copy" onclick="copyToClipboard('${copyLink}', this)">
                                <i class="fas fa-copy"></i> کپی لینک
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> کپی شد!';
                button.disabled = true;
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }

        async function loadProxies() {
            elements.statusMessage.classList.remove('hidden');
            elements.statusMessage.textContent = 'در حال دریافت پروکسی‌ها...';
            allProxies = await fetchProxies();
            if (allProxies.length > 0) {
                elements.statusMessage.textContent = 'پروکسی‌ها با موفقیت بارگذاری شدند. در حال تست سرعت...';
                allProxies = await testAllProxies(allProxies);
                elements.statusMessage.textContent = '';
                applyFiltersAndSort();
            } else {
                elements.statusMessage.textContent = 'هیچ پروکسی پیدا نشد.';
            }
        }
        
        async function testAllProxies() {
            elements.testAllBtn.disabled = true;
            elements.testAllBtn.innerHTML = '<span class="loading-animation"></span> در حال تست...';

            const proxiesToTest = allProxies.map((proxy, index) => ({
                ...proxy,
                originalIndex: index
            }));

            const testPromises = proxiesToTest.map(async (proxy) => {
                const ping = await testProxy(proxy);
                proxy.ping = ping;
                const pingElement = document.getElementById(`ping-${proxy.originalIndex}`);
                if (pingElement) {
                    pingElement.innerHTML = getPingBadgeHTML(ping);
                }
                return proxy;
            });

            await Promise.all(testPromises);
            elements.testAllBtn.disabled = false;
            elements.testAllBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> تست همه';
            return proxiesToTest;
        }

        function applyFiltersAndSort() {
            let filteredProxies = allProxies.filter(proxy => {
                const countryInfo = countryTranslations[proxy.country] || { name: proxy.country };
                return countryInfo.name.toLowerCase().includes(currentSearch.toLowerCase());
            });

            if (currentSort === 'fastest') {
                filteredProxies.sort((a, b) => {
                    const pingA = a.ping > 0 ? a.ping : Infinity;
                    const pingB = b.ping > 0 ? b.ping : Infinity;
                    return pingA - pingB;
                });
            } else if (currentSort === 'newest') {
                filteredProxies.sort((a, b) => b.createdAt - a.createdAt);
            }

            renderProxies(filteredProxies);
        }

        function renderProxies(proxies) {
            elements.proxyGrid.innerHTML = '';
            displayedProxiesCount = 0;
            elements.loadMoreContainer.style.display = 'none';

            if (proxies.length === 0) {
                elements.statusMessage.classList.remove('hidden');
                elements.statusMessage.textContent = 'هیچ پروکسی با این مشخصات یافت نشد.';
                return;
            }

            elements.statusMessage.classList.add('hidden');
            appendProxies(proxies);
        }

        function appendProxies(proxies) {
            const proxiesToRender = proxies.slice(displayedProxiesCount, displayedProxiesCount + perPage);
            proxiesToRender.forEach(proxy => {
                elements.proxyGrid.innerHTML += getProxyCardHTML(proxy, allProxies.indexOf(proxy));
            });

            displayedProxiesCount += proxiesToRender.length;

            if (displayedProxiesCount < proxies.length) {
                elements.loadMoreContainer.style.display = 'flex';
            } else {
                elements.loadMoreContainer.style.display = 'none';
            }
        }
        
        function showWelcomeModal() {
            if (!localStorage.getItem('welcomeModalShown')) {
                elements.welcomeModal.style.display = 'flex';
            }
        }

        function hideWelcomeModal() {
            elements.welcomeModal.style.display = 'none';
            localStorage.setItem('welcomeModalShown', 'true');
        }

        if(elements.closeModalBtn) {
            elements.closeModalBtn.addEventListener('click', () => {
                hideWelcomeModal();
            });
        }


        elements.refreshBtn.addEventListener('click', loadProxies);
        elements.testAllBtn.addEventListener('click', testAllProxies);
        elements.loadMoreBtn.addEventListener('click', () => {
            applyFiltersAndSort();
        });
        
        elements.searchInput.addEventListener('input', (e) => {
            currentSearch = e.target.value;
            applyFiltersAndSort();
        });
        
        elements.sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            applyFiltersAndSort();
        });
        
        elements.perPageSelect.addEventListener('change', (e) => {
            perPage = parseInt(e.target.value);
            applyFiltersAndSort();
        });

        window.addEventListener('load', () => {
            loadProxies();
            setTimeout(showWelcomeModal, 700);
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered!', reg))
                    .catch(err => console.log('Service Worker registration failed: ', err));
            });
        }
    </script>
    
    <script src="/pwa-install.js"></script>

</body>
</html>
